// Prisma Schema for Backup Service
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Логи всех созданных бэкапов
model BackupLog {
  id          String   @id @default(uuid())
  fileName    String   // backup-20250122-030000.sql.gz
  s3Key       String   // daily/backup-20250122-030000.sql.gz
  s3Bucket    String   // devcrm-backups
  type        BackupType // MANUAL, DAILY, WEEKLY, MONTHLY
  status      BackupStatus @default(IN_PROGRESS)
  size        BigInt?  // Размер файла в байтах
  databaseUrl String?  // Частичный URL (без пароля)
  startedAt   DateTime @default(now())
  completedAt DateTime?
  errorMessage String?  @db.Text
  metadata    Json?    // Дополнительные данные
  
  @@index([type])
  @@index([status])
  @@index([startedAt])
  @@map("backup_logs")
}

enum BackupType {
  MANUAL
  DAILY
  WEEKLY
  MONTHLY
}

enum BackupStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
  DELETED
}

// Настройки расписания бэкапов
model BackupSchedule {
  id          String   @id @default(uuid())
  type        BackupType @unique
  cronExpression String // "0 3 * * *" для daily
  enabled     Boolean  @default(true)
  retentionDays Int    // Сколько дней хранить
  lastRun     DateTime?
  nextRun     DateTime?
  updatedAt   DateTime @updatedAt
  
  @@map("backup_schedules")
}

