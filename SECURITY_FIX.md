# üîí Security Fix: Scheduler-Only Mode

## ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### 1. **backup.controller.ts** - —É–¥–∞–ª–µ–Ω—ã –æ–ø–∞—Å–Ω—ã–µ endpoint'—ã
- ‚ùå `POST /create` - —É–¥–∞–ª–µ–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è scheduler)
- ‚ùå `POST /:id/restore` - —É–¥–∞–ª–µ–Ω (—Å–ª–∏—à–∫–æ–º –æ–ø–∞—Å–Ω–æ)
- ‚ùå `DELETE /:id` - —É–¥–∞–ª–µ–Ω (—Å–ª–∏—à–∫–æ–º –æ–ø–∞—Å–Ω–æ)
- ‚ùå `POST /schedule` - —É–¥–∞–ª–µ–Ω (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ ENV)

### 2. **backup.scheduler.ts** - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ ENV
- –¢–µ–ø–µ—Ä—å —á–∏—Ç–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å/–æ—Ç–∫–ª—é—á–∞—Ç—å –∫–∞–∂–¥—ã–π —Ç–∏–ø backup'–∞

### 3. **main.ts** - Swagger —Ç–æ–ª—å–∫–æ –≤ dev
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –≤ production
- –ú–æ–∂–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ `SWAGGER_ENABLED`

### 4. **env.example** - –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ backup'–æ–≤
- –ì–æ—Ç–æ–≤ –∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—é

## üìã –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### 1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ env.example
```bash
cp env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
```

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
```env
# –í–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å backup'—ã
BACKUP_DAILY_ENABLED=true
BACKUP_WEEKLY_ENABLED=true
BACKUP_MONTHLY_ENABLED=false

# –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (cron)
BACKUP_DAILY_CRON=0 3 * * *

# Retention (–¥–Ω–∏)
BACKUP_DAILY_RETENTION=7
```

### 3. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ
```bash
npm run build
npm run start:prod
```

## üõ°Ô∏è –ß—Ç–æ —Ç–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ

‚úÖ –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å backup —á–µ—Ä–µ–∑ API  
‚úÖ –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å backup —á–µ—Ä–µ–∑ API  
‚úÖ –ù–µ–ª—å–∑—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î —á–µ—Ä–µ–∑ API  
‚úÖ –ù–µ–ª—å–∑—è –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ backup'–æ–≤ —á–µ—Ä–µ–∑ API  
‚úÖ –ù–µ–ª—å–∑—è —É–∑–Ω–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î —á–µ—Ä–µ–∑ API  
‚úÖ Swagger –æ—Ç–∫–ª—é—á–µ–Ω –≤ production  
‚úÖ –¢–æ–ª—å–∫–æ health check (–±–µ–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ—ã)

**–ü–æ—á–µ–º—É —É–¥–∞–ª–µ–Ω—ã –¥–∞–∂–µ read-only endpoint'—ã?**
–û–Ω–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
- –ö–æ–≥–¥–∞ –¥–µ–ª–∞—é—Ç—Å—è backup'—ã (schedule)
- –†–∞–∑–º–µ—Ä backup'–æ–≤ (–º–æ–∂–Ω–æ —É–≥–∞–¥–∞—Ç—å —Ä–∞–∑–º–µ—Ä –ë–î)
- –°—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î (—Ç–∞–±–ª–∏—Ü—ã, –≤–µ—Ä—Å–∏—è PostgreSQL)
- –ò—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π

## üîß –ö–∞–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å backup'—ã

### –í–∞—Ä–∏–∞–Ω—Ç 1: kubectl logs
```bash
kubectl logs -n backend -l app=backup-service -f
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: kubectl exec
```bash
# –í–æ–π—Ç–∏ –≤ pod
kubectl exec -it -n backend deployment/backup-service -- sh

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ backup'—ã —á–µ—Ä–µ–∑ –ë–î
npx prisma studio
# –ò–ª–∏ —á–µ—Ä–µ–∑ psql –Ω–∞–ø—Ä—è–º—É—é –∫ –ë–î
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: S3 bucket
```bash
aws s3 ls s3://devcrm-backups/daily/
aws s3 ls s3://devcrm-backups/weekly/
aws s3 ls s3://devcrm-backups/monthly/
```

## üÜò Manual –æ–ø–µ—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

```bash
# –í–æ–π—Ç–∏ –≤ pod
kubectl exec -it -n backend deployment/backup-service -- sh

# –í–Ω—É—Ç—Ä–∏ pod'–∞ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é:
# 1. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ backup'–æ–≤
psql $DATABASE_URL -c "SELECT * FROM backup_logs ORDER BY started_at DESC LIMIT 10"

# 2. –°–æ–∑–¥–∞—Ç—å manual backup (–µ—Å–ª–∏ –æ—á–µ–Ω—å –Ω—É–∂–Ω–æ)
# –î–æ–±–∞–≤—å—Ç–µ –≤ package.json:
# "backup:manual": "node -e \"require('./dist/backup/backup.service').createBackup('MANUAL')\""
npm run backup:manual

# 3. –î–ª—è restore - –û–ß–ï–ù–¨ –û–°–¢–û–†–û–ñ–ù–û!
# –õ—É—á—à–µ –¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ psql
```

## üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ endpoint'—ã

**–¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—É–±–ª–∏—á–Ω—ã–π endpoint:**

- `GET /api/v1/backup/health` - —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞ (ok/error)

**–í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.**

